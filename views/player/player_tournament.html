<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Player Tournaments - ChessHive</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root {
      --sea-green: #2E8B57;
      --cream: #FFFDD0;
      --sky-blue: #87CEEB;
      --dark-green: #236B43;
      --light-gray: #f9f9f9;
      --red: #ff4d4d;
      --yellow: #ffcc00;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Playfair Display', serif;
      background-color: var(--cream);
      min-height: 100vh;
      padding-bottom: 60px;
    }

    .content {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    h1, h2 {
      font-family: 'Cinzel', serif;
      color: var(--sea-green);
      margin-bottom: 1rem;
    }

    .black-h2 {
      color: var(--sea-green);
      font-family: 'Cinzel', serif;
      margin-top: 2rem;
      margin-bottom: 0.5rem;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 600px;
    }

    th {
      background-color: var(--sea-green);
      color: white;
      padding: 12px;
      text-align: left;
    }

    td {
      padding: 12px;
      border: 1px solid #ddd;
    }

    tr:hover {
      background-color: var(--light-gray);
    }

    .status-ongoing {
      color: var(--yellow);
      font-weight: bold;
    }

    .status-yet-to-start {
      color: var(--sea-green);
      font-weight: bold;
    }

    .wallet-section {
      background-color: var(--sea-green);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .wallet-section h3 {
      color: white;
      margin-top: 0;
      margin-bottom: 1rem;
    }

    .wallet-section form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
      margin: 0 auto;
    }

    .wallet-section input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--sea-green);
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .wallet-section button {
      background-color: var(--sky-blue);
      color: var(--sea-green);
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      font-family: 'Cinzel', serif;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }

    .wallet-section button:hover {
      background-color: #6CB4D4;
      transform: translateY(-2px);
    }

    .tournament-name {
      cursor: pointer;
      color: var(--sea-green);
      font-weight: bold;
    }

    .tournament-details {
      display: none;
      padding: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      margin-top: 10px;
    }

    .back-to-dashboard {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: var(--sea-green);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-weight: bold;
      z-index: 1000;
    }

    button, .btn {
      background-color: var(--sea-green);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Playfair Display', serif;
      margin: 5px 2px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      background-color: var(--sky-blue);
      color: var(--sea-green);
      font-family: 'Cinzel', serif;
      font-weight: bold;
    }

    button:hover, .btn:hover, .back-to-dashboard:hover {
      background-color: var(--dark-green);
      transform: translateY(-2px);
    }

    button[disabled] {
      background-color: gray;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .subscription-message {
      background-color: var(--sky-blue);
      color: var(--sea-green);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .subscription-message a {
      color: var(--sea-green);
      text-decoration: underline;
    }

    .search-box {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box input {
      padding: 0.6rem 1rem;
      width: 100%;
      max-width: 300px;
      border: 2px solid var(--sea-green);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Playfair Display', serif;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--dark-green);
      box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
    }

    .search-box select {
      padding: 0.6rem 1rem;
      border: 2px solid var(--sea-green);
      border-radius: 8px;
      font-size: 1rem;
      background-color: white;
      color: var(--sea-green);
      font-family: 'Cinzel', serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-box select:focus {
      outline: none;
      border-color: var(--dark-green);
      box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
    }

    .search-box select:hover {
      background-color: var(--light-gray);
    }

    .join-form {
      display: none;
    }

    .join-form.active {
      display: block;
    }

    .more-container {
      text-align: center;
      margin: 1rem 0;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .more, .hide {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--sky-blue);
      color: var(--sea-green);
      text-decoration: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'Cinzel', serif;
      font-weight: bold;
      cursor: pointer;
    }

    .more:hover, .hide:hover {
      background-color: #6CB4D4;
      transform: translateY(-2px);
    }

    .empty-message {
      text-align: center;
      padding: 2rem;
      color: var(--sea-green);
      font-style: italic;
    }

    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .content { padding: 1rem; }
      .back-to-dashboard { bottom: 20px; right: 20px; }
      .btn { width: 100%; justify-content: center; }
      table { font-size: 0.9rem; }
      .wallet-section form {
        max-width: 100%;
      }
      .wallet-section input[type="number"],
      .wallet-section button {
        width: 100%;
      }
      .more-container {
        flex-direction: column;
        gap: 0.5rem;
      }
      .search-box {
        flex-direction: column;
        align-items: stretch;
      }
      .search-box input,
      .search-box select {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="content">
    <h1><i class="fas fa-trophy"></i> Tournaments</h1>

    <!-- Success/Error messages placeholder -->
    <div id="messageContainer"></div>

    <!-- Subscription message placeholder -->
    <div id="subscriptionMessage" class="subscription-message" style="display:none">
      YOU MUST BE SUBSCRIBED TO JOIN TOURNAMENTS. <a href="/player/subscription">Subscribe Now</a>
    </div>

    <!-- Wallet Section -->
    <div class="wallet-section">
      <span class="wallet-icon">ðŸ’°</span>
      <h3>Wallet Balance: â‚¹<span id="walletBalance">0</span></h3>
      <form id="addFundsForm">
        <input type="number" name="amount" placeholder="Enter amount" min="1" required>
        <input type="hidden" name="redirectTo" value="/player/player_tournament">
        <button type="submit">Add Funds</button>
      </form>
    </div>

    <!-- Individual Tournaments -->
    <h2 class="black-h2">Available Individual Tournaments</h2>
    <div class="search-box">
      <input type="text" placeholder="Search individual tournaments..." id="searchIndividual">
      <select id="searchIndividualType">
        <option value="name">Name</option>
        <option value="location">Location</option>
        <option value="status">Status</option>
      </select>
    </div>
    <div class="form-container">
      <table id="individualTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Location</th>
            <th>Entry Fee</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="individualTournamentsTable">
          <!-- Rows populated dynamically via JS -->
        </tbody>
      </table>
    </div>
    <div class="more-container">
      <a href="#" class="more" id="individualMoreLink" style="display:none">
        <i class="fas fa-chevron-down"></i> More
      </a>
      <a href="#" class="hide" id="individualHideLink" style="display:none">
        <i class="fas fa-chevron-up"></i> Hide
      </a>
    </div>

    <!-- Team Tournaments -->
    <h2 class="black-h2">Available Team Tournaments</h2>
    <div class="search-box">
      <input type="text" placeholder="Search team tournaments..." id="searchTeam">
      <select id="searchTeamType">
        <option value="name">Name</option>
        <option value="location">Location</option>
        <option value="status">Status</option>
      </select>
    </div>
    <div class="form-container">
      <table id="teamTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Location</th>
            <th>Entry Fee</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="teamTournamentsTable">
          <!-- Rows populated dynamically via JS -->
        </tbody>
      </table>
    </div>
    <div class="more-container">
      <a href="#" class="more" id="teamMoreLink" style="display:none">
        <i class="fas fa-chevron-down"></i> More
      </a>
      <a href="#" class="hide" id="teamHideLink" style="display:none">
        <i class="fas fa-chevron-up"></i> Hide
      </a>
    </div>
  </div>

  <a href="/player/player_dashboard" class="back-to-dashboard">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </a>

  <script>
    // Filter function
function filterTournaments(searchInputId, selectId, tableId) {
  const searchInput = document.getElementById(searchInputId);
  const filterType = document.getElementById(selectId);
  const tableBody = document.getElementById(tableId);

  function applyFilter() {
    const filterText = searchInput.value.toLowerCase().trim();
    const filterBy = filterType.value;

    Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length < 5) return; // skip empty message rows

      let match = false;
      if (filterBy === 'name') {
        match = cells[0].textContent.toLowerCase().includes(filterText);
      } else if (filterBy === 'location') {
        match = cells[2].textContent.toLowerCase().includes(filterText);
      } else if (filterBy === 'status') {
        match = cells[4].textContent.toLowerCase().includes(filterText);
      }

      row.style.display = match || filterText === '' ? '' : 'none';
    });
  }

  searchInput.addEventListener('input', applyFilter);
  filterType.addEventListener('change', applyFilter);
}

filterTournaments('searchIndividual', 'searchIndividualType', 'individualTournamentsTable');
filterTournaments('searchTeam', 'searchTeamType', 'teamTournamentsTable');

document.addEventListener('DOMContentLoaded', async () => {
  const walletBalanceEl = document.getElementById('walletBalance');
  const subscriptionMessageEl = document.getElementById('subscriptionMessage');
  const messageContainerEl = document.getElementById('messageContainer');
  const individualTableBody = document.getElementById('individualTournamentsTable');
  const teamTableBody = document.getElementById('teamTournamentsTable');
  let isLoading = false;
  
  // Track visible rows for pagination
  let individualVisibleCount = 5;
  let teamVisibleCount = 5;
  const ROWS_PER_PAGE = 5;

  // Display error or success message
  function showMessage(message, isError = false) {
    messageContainerEl.innerHTML = `<div style="padding: 15px; border-radius: 5px; margin-bottom: 20px; background-color: ${isError ? 'var(--red)' : 'var(--sky-blue)'}; color: ${isError ? 'white' : 'var(--sea-green)'}; font-weight: bold;">${message}</div>`;
  }

  // Fetch wallet & subscription status
  async function loadWalletAndSubscription() {
    try {
      const res = await fetch('/player/api/profile', { credentials: 'same-origin' });
      if (!res.ok) {
        throw new Error(`HTTP error! Status: ${res.status}`);
      }
      const data = await res.json();
      console.log('Profile API response:', data);
      walletBalanceEl.textContent = data.player.walletBalance ?? 0;
      const subscribed = data.player.subscription && new Date(data.player.subscription.end_date) > new Date();
      if (!subscribed) {
        subscriptionMessageEl.style.display = 'block';
      }
    } catch (err) {
      console.error('Error loading wallet and subscription:', err);
      showMessage('Failed to load wallet balance and subscription status.', true);
      walletBalanceEl.textContent = 0;
    }
  }

  // Fetch tournaments with retry
  async function loadTournaments(retryCount = 3, delay = 1000) {
    if (isLoading) return;
    isLoading = true;
    teamTableBody.classList.add('loading');
    try {
      for (let attempt = 1; attempt <= retryCount; attempt++) {
        const res = await fetch('/player/api/tournaments', {
          credentials: 'same-origin',
          headers: { 'Cache-Control': 'no-cache' }
        });
        console.log(`Tournaments API attempt ${attempt} status:`, res.status);
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        const data = await res.json();
        console.log('Tournaments API response (enrolledTeamTournaments):', JSON.stringify(data.enrolledTeamTournaments, null, 2));
        renderTournaments(data);
        break;
      }
    } catch (err) {
      console.error(`Error loading tournaments (attempt ${attempt}):`, err);
      if (attempt < retryCount) {
        console.log(`Retrying after ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      } else {
        showMessage(`Failed to load tournaments: ${err.message}`, true);
      }
    } finally {
      isLoading = false;
      teamTableBody.classList.remove('loading');
    }
  }

  // Render tournaments
  function renderTournaments(data) {
    const today = new Date();
    const subscribed = data.currentSubscription && new Date(data.currentSubscription.end_date) > new Date();
    const currentUser = data.username;

    console.log('Tournament types:', data.tournaments.map(t => ({
      name: t.name,
      type: t.type || 'undefined',
      _id: t._id
    })));

    const individualTournaments = data.tournaments
      .filter(t => {
        const type = t.type ? t.type.toLowerCase() : 'individual';
        return type === 'individual' || type === 'solo';
      })
      .map(t => ({
        ...t,
        alreadyEnrolled: data.enrolledIndividualTournaments.some(e => e.tournament._id.toString() === t._id.toString()),
        subscribed
      }));

    const teamTournaments = data.tournaments
      .filter(t => {
        const type = t.type ? t.type.toLowerCase() : null;
        return type === 'team' || type === 'group';
      })
      .map(t => {
        const enrollment = data.enrolledTeamTournaments.find(e => e.tournament._id.toString() === t._id.toString());
        const teamData = {
          ...t,
          alreadyJoined: !!enrollment,
          approved: enrollment ? enrollment.approved : false,
          enrollmentId: enrollment ? enrollment._id : null,
          needsApproval: enrollment && (
            (enrollment.player1_name === currentUser && !enrollment.player1_approved) ||
            (enrollment.player2_name === currentUser && !enrollment.player2_approved) ||
            (enrollment.player3_name === currentUser && !enrollment.player3_approved)
          ),
          player1_name: enrollment ? enrollment.player1_name : null,
          player2_name: enrollment ? enrollment.player2_name : null,
          player3_name: enrollment ? enrollment.player3_name : null,
          player1_approved: enrollment ? enrollment.player1_approved : false,
          player2_approved: enrollment ? enrollment.player2_approved : false,
          player3_approved: enrollment ? enrollment.player3_approved : false,
          subscribed
        };
        console.log(`Team tournament ${t.name} enrollment:`, {
          tournamentId: t._id,
          alreadyJoined: teamData.alreadyJoined,
          approved: teamData.approved,
          needsApproval: teamData.needsApproval,
          players: {
            player1: { name: teamData.player1_name, approved: teamData.player1_approved },
            player2: { name: teamData.player2_name, approved: teamData.player2_approved },
            player3: { name: teamData.player3_name, approved: teamData.player3_approved }
          }
        });
        return teamData;
      });

    console.log('Individual tournaments:', individualTournaments);
    console.log('Team tournaments:', teamTournaments);

    // Render Individual Tournaments with pagination tracking
    individualTableBody.innerHTML = individualTournaments.length === 0 
      ? '<tr><td colspan="6" class="empty-message">No individual tournaments available</td></tr>' 
      : '';
    individualTournaments.forEach((t, idx) => {
      const row = document.createElement('tr');
      row.style.display = idx < individualVisibleCount ? '' : 'none'; // Only show first N rows
      const tournamentDate = new Date(t.date);
      const status = tournamentDate.toDateString() === today.toDateString() ? 'Ongoing' : 'Yet to Start';
      const statusClass = tournamentDate.toDateString() === today.toDateString() ? 'status-ongoing' : 'status-yet-to-start';
      let actions = '';

      if (!t.alreadyEnrolled) {
        actions = `<form class="join-individual-form" data-tournament-id="${t._id}">
                    <input type="hidden" name="tournamentId" value="${t._id}">
                    <button type="submit" ${!subscribed ? 'disabled' : ''}>
                      Join ${!subscribed ? '(SUBSCRIPTION REQUIRED)' : ''}
                    </button>
                  </form>`;
      } else {
        actions = `<span class="enrolled-text">ENROLLED</span><br/>
                   <a href="/player/pairings?tournament_id=${t._id}&rounds=5" class="btn">
                     <i class="fas fa-chess-board"></i> View Pairings
                   </a>
                   <a href="/player/rankings?tournament_id=${t._id}" class="btn">
                     <i class="fas fa-medal"></i> Final Rankings
                   </a>`;
      }

      row.innerHTML = `
        <td>${t.name}</td>
        <td>${tournamentDate.toLocaleDateString()}</td>
        <td>${t.location}</td>
        <td>â‚¹${t.entry_fee}</td>
        <td class="${statusClass}">${status}</td>
        <td>${actions}</td>
      `;
      individualTableBody.appendChild(row);
    });

    // Render Team Tournaments with pagination tracking
    teamTableBody.innerHTML = teamTournaments.length === 0 
      ? '<tr><td colspan="6" class="empty-message">No team tournaments available</td></tr>' 
      : '';
    teamTournaments.forEach((t, idx) => {
      const row = document.createElement('tr');
      row.style.display = idx < teamVisibleCount ? '' : 'none'; // Only show first N rows
      const tournamentDate = new Date(t.date);
      const status = tournamentDate.toDateString() === today.toDateString() ? 'Ongoing' : 'Yet to Start';
      const statusClass = tournamentDate.toDateString() === today.toDateString() ? 'status-ongoing' : 'status-yet-to-start';
      let actions = '';

      if (!t.alreadyJoined) {
        actions = `<button type="button" class="join-team-btn" data-form-id="join-form-${t._id}" ${!subscribed ? 'disabled' : ''}>
                    Join ${!subscribed ? '(SUBSCRIPTION REQUIRED)' : ''}
                   </button>
                   <div id="join-form-${t._id}" class="join-form">
                     <form class="team-join-form" data-tournament-id="${t._id}">
                       <input type="hidden" name="tournamentId" value="${t._id}">
                       <label>Player 1:</label><input type="text" name="player1" required>
                       <label>Player 2:</label><input type="text" name="player2" required>
                       <label>Player 3:</label><input type="text" name="player3" required>
                       <button type="submit">Submit Team</button>
                     </form>
                   </div>`;
      } else {
        let statusText = t.approved 
          ? `<span class="enrolled-text">ENROLLED</span>`
          : `<span class="enrolled-text" style="color: var(--yellow); font-weight: bold;">PENDING APPROVAL</span>`;
        let approvalButton = '';
        if (t.needsApproval) {
          approvalButton = `<button class="approve-team-btn" data-request-id="${t.enrollmentId}">Approve</button>`;
        }
        actions = `${statusText}${approvalButton ? `<br/>${approvalButton}` : ''}`;
        if (t.approved) {
          actions += `<br/>
                      <a href="/player/pairings?tournament_id=${t._id}&rounds=5" class="btn">
                        <i class="fas fa-chess-board"></i> View Pairings
                      </a>
                      <a href="/player/rankings?tournament_id=${t._id}" class="btn">
                        <i class="fas fa-medal"></i> Final Rankings
                      </a>`;
        }
      }

      row.innerHTML = `
        <td>${t.name}</td>
        <td>${tournamentDate.toLocaleDateString()}</td>
        <td>${t.location}</td>
        <td>â‚¹${t.entry_fee}</td>
        <td class="${statusClass}">${status}</td>
        <td>${actions}</td>
      `;
      teamTableBody.appendChild(row);
    });

    // Update pagination visibility
    updatePaginationVisibility(individualTournaments.length, 'individual');
    updatePaginationVisibility(teamTournaments.length, 'team');

    bindTeamButtons();
    bindJoinForms();
    bindApproveButtons();
  }

  // Update pagination button visibility
  function updatePaginationVisibility(totalRows, type) {
    const moreLinkId = type === 'individual' ? 'individualMoreLink' : 'teamMoreLink';
    const hideLinkId = type === 'individual' ? 'individualHideLink' : 'teamHideLink';
    const visibleCount = type === 'individual' ? individualVisibleCount : teamVisibleCount;
    
    const moreLink = document.getElementById(moreLinkId);
    const hideLink = document.getElementById(hideLinkId);
    
    moreLink.style.display = visibleCount < totalRows ? 'inline-flex' : 'none';
    hideLink.style.display = visibleCount > ROWS_PER_PAGE ? 'inline-flex' : 'none';
  }

  // Pagination for individual tournaments - SHOW NEXT 5 ONLY
  document.getElementById('individualMoreLink').addEventListener('click', (e) => {
    e.preventDefault();
    const rows = document.querySelectorAll('#individualTable tbody tr');
    const start = individualVisibleCount;
    const end = Math.min(start + ROWS_PER_PAGE, rows.length);
    
    // Show next 5 rows
    for (let i = start; i < end; i++) {
      rows[i].style.display = '';
    }
    
    individualVisibleCount = end;
    
    // Update button visibility
    updatePaginationVisibility(rows.length, 'individual');
  });

  // Hide individual tournaments - RESET TO FIRST 5
  document.getElementById('individualHideLink').addEventListener('click', (e) => {
    e.preventDefault();
    const rows = document.querySelectorAll('#individualTable tbody tr');
    
    // Hide all except first 5
    rows.forEach((row, idx) => {
      row.style.display = idx < ROWS_PER_PAGE ? '' : 'none';
    });
    
    individualVisibleCount = ROWS_PER_PAGE;
    
    // Update button visibility
    updatePaginationVisibility(rows.length, 'individual');
  });

  // Pagination for team tournaments - SHOW NEXT 5 ONLY
  document.getElementById('teamMoreLink').addEventListener('click', (e) => {
    e.preventDefault();
    const rows = document.querySelectorAll('#teamTable tbody tr');
    const start = teamVisibleCount;
    const end = Math.min(start + ROWS_PER_PAGE, rows.length);
    
    // Show next 5 rows
    for (let i = start; i < end; i++) {
      rows[i].style.display = '';
    }
    
    teamVisibleCount = end;
    
    // Update button visibility
    updatePaginationVisibility(rows.length, 'team');
  });

  // Hide team tournaments - RESET TO FIRST 5
  document.getElementById('teamHideLink').addEventListener('click', (e) => {
    e.preventDefault();
    const rows = document.querySelectorAll('#teamTable tbody tr');
    
    // Hide all except first 5
    rows.forEach((row, idx) => {
      row.style.display = idx < ROWS_PER_PAGE ? '' : 'none';
    });
    
    teamVisibleCount = ROWS_PER_PAGE;
    
    // Update button visibility
    updatePaginationVisibility(rows.length, 'team');
  });

  // Bind team join buttons
  function bindTeamButtons() {
    document.querySelectorAll('.join-team-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.join-form').forEach(f => f.classList.remove('active'));
        const formId = btn.getAttribute('data-form-id');
        const form = document.getElementById(formId);
        if (form) form.classList.add('active');
      });
    });
  }

  // Bind join form submissions
  function bindJoinForms() {
    document.querySelectorAll('.join-individual-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;
        isLoading = true;
        form.classList.add('loading');
        const tournamentId = form.getAttribute('data-tournament-id');
        const row = form.closest('tr');
        try {
          const res = await fetch('/player/api/join-individual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ tournamentId })
          });
          const result = await res.json();
          if (res.ok) {
            showMessage(result.message);
            walletBalanceEl.textContent = result.walletBalance;
            // Update the row with new actions without refresh
            row.querySelector('td:last-child').innerHTML = `
              <span class="enrolled-text">ENROLLED</span><br/>
              <a href="/player/pairings?tournament_id=${tournamentId}&rounds=5" class="btn">
                <i class="fas fa-chess-board"></i> View Pairings
              </a>
              <a href="/player/rankings?tournament_id=${tournamentId}" class="btn">
                <i class="fas fa-medal"></i> Final Rankings
              </a>
            `;
          } else {
            showMessage(result.error || 'Failed to join tournament', true);
          }
        } catch (err) {
          console.error('Error joining individual tournament:', err);
          showMessage('Error joining tournament.', true);
        } finally {
          isLoading = false;
          form.classList.remove('loading');
        }
      });
    });

    document.querySelectorAll('.team-join-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;
        isLoading = true;
        form.classList.add('loading');
        const tournamentId = form.getAttribute('data-tournament-id');
        const row = form.closest('tr').parentElement.closest('tr');
        const formContainer = form.closest('.join-form');
        const data = {
          tournamentId,
          player1: form.player1.value,
          player2: form.player2.value,
          player3: form.player3.value
        };
        try {
          const res = await fetch('/player/api/join-team', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          });
          const result = await res.json();
          if (res.ok) {
            showMessage(result.message);
            walletBalanceEl.textContent = result.walletBalance;
            // Update the row with new status
            row.querySelector('td:last-child').innerHTML = `
              <span class="enrolled-text" style="color: var(--yellow); font-weight: bold;">PENDING APPROVAL</span>
            `;
            formContainer.classList.remove('active');
          } else {
            showMessage(result.error || 'Failed to join team tournament', true);
          }
        } catch (err) {
          console.error('Error joining team tournament:', err);
          showMessage('Error joining team tournament.', true);
        } finally {
          isLoading = false;
          form.classList.remove('loading');
        }
      });
    });
  }

  // Bind approve buttons
  function bindApproveButtons() {
    document.querySelectorAll('.approve-team-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (isLoading) return;
        isLoading = true;
        btn.classList.add('loading');
        const requestId = btn.getAttribute('data-request-id');
        try {
          const res = await fetch('/player/api/approve-team-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' },
            credentials: 'same-origin',
            body: JSON.stringify({ requestId })
          });
          const result = await res.json();
          console.log('Approve team request response:', result);
          if (res.ok) {
            showMessage('Team request approved successfully!');
            setTimeout(async () => {
              await loadTournaments();
            }, 1000); // Increased delay for backend update
          } else {
            showMessage(result.error || 'Failed to approve team request', true);
          }
        } catch (err) {
          console.error('Error approving team request:', err);
          showMessage('Error approving team request.', true);
        } finally {
          isLoading = false;
          btn.classList.remove('loading');
        }
      });
    });
  }

  // Add funds form submit
  document.getElementById('addFundsForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (isLoading) return;
    isLoading = true;
    const form = e.target;
    form.classList.add('loading');
    const amount = form.amount.value;
    try {
      const res = await fetch('/player/api/add-funds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ amount: parseInt(amount, 10) })
      });
      const result = await res.json();
      if (res.ok) {
        walletBalanceEl.textContent = result.walletBalance;
        showMessage('Funds added successfully!');
      } else {
        showMessage(result.error || 'Failed to add funds', true);
      }
    } catch (err) {
      console.error('Error adding funds:', err);
      showMessage('Error adding funds.', true);
    } finally {
      isLoading = false;
      form.classList.remove('loading');
    }
  });

  await loadWalletAndSubscription();
  await loadTournaments();
});
</script>
</body>
</html>