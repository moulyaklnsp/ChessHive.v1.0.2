<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Management - ChessHive</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sea-green: #2E8B57;
            --cream: #FFFDD0;
            --sky-blue: #87CEEB;
            --dark-green: #236B43;
            --light-gray: #f9f9f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Playfair Display', serif;
            background-color: var(--cream);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h2, h3, h4 {
            font-family: 'Cinzel', serif;
            color: var(--sea-green);
        }

        h2 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        h2::before {
            content: '♟️';
            font-size: 2.5rem;
        }

        h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        h4 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: #666;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success {
            background-color: rgba(46, 139, 87, 0.1);
            color: var(--sea-green);
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
        }

        .table-div {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        th {
            background-color: var(--sea-green);
            color: white;
            padding: 1rem;
            text-align: left;
            font-family: 'Cinzel', serif;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(46, 139, 87, 0.2);
        }

        tr:hover {
            background-color: rgba(135, 206, 235, 0.1);
        }

        .status-completed { 
            color: var(--sea-green);
            font-weight: bold;
        }

        .status-ongoing { 
            color: var(--sky-blue);
            font-weight: bold;
        }

        .status-yet-to-start { 
            color: #666;
            font-weight: bold;
        }

        .status-pending { 
            color: #c62828;
            font-weight: bold;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--sky-blue);
            color: var(--sea-green);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            margin: 0.2rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-remove {
            background: #c62828;
            color: var(--cream);
        }

        .btn-remove:hover {
            background: #a12020;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-feedback {
            background: var(--sea-green);
            color: var(--cream);
        }

        .btn-feedback:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .back-container {
            text-align: right;
            margin-top: 2rem;
        }

        .back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--sea-green);
            color: white;
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            font-weight: bold;
        }

        .back:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-container {
            width: 100%;
            padding: 2rem 0;
        }

        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--sea-green);
            font-weight: bold;
            font-size: 1.1rem;
        }

        input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--sea-green);
            border-radius: 8px;
            font-size: 1.2rem;
            min-height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-family: 'Playfair Display', serif;
        }

        input:focus {
            outline: none;
            border-color: var(--sky-blue);
            box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.2);
        }

        select {
            width: 100%;
            padding: 0.6rem 1rem;
            border: 2px solid var(--sea-green);
            border-radius: 8px;
            font-size: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            color: var(--sea-green);
        }

        select:focus {
            outline: none;
            border-color: var(--dark-green);
            box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
        }

        select:hover {
            background-color: var(--light-gray);
        }

        .add-tournament-button {
            grid-column: 1 / -1;
        }

        button {
            background-color: var(--sea-green);
            color: var(--cream);
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .searchBarContainer {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .searchBarContainer input {
            padding: 0.4rem 0.8rem;
            width: 100%;
            max-width: 200px;
            border: 2px solid var(--sea-green);
            border-radius: 8px;
            font-size: 0.9rem;
            min-height: 36px;
            transition: all 0.3s ease;
            font-family: 'Playfair Display', serif;
        }

        .searchBarContainer input:focus {
            outline: none;
            border-color: var(--dark-green);
            box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
        }

        .searchBarContainer select {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--sea-green);
            border-radius: 8px;
            font-size: 0.9rem;
            min-height: 36px;
            background-color: white;
            color: var(--sea-green);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .searchBarContainer select:focus {
            outline: none;
            border-color: var(--dark-green);
            box-shadow: 0 0 5px rgba(46, 139, 87, 0.3);
        }

        .searchBarContainer select:hover {
            background-color: var(--light-gray);
        }

        .more-container {
            text-align: center;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .more, .hide {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--sky-blue);
            color: var(--sea-green);
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            cursor: pointer;
        }

        .more:hover, .hide:hover {
            background-color: #5f9ece;
            transform: translateY(-2px);
        }

        .empty-message {
            text-align: center;
            padding: 2rem;
            color: var(--sea-green);
            font-style: italic;
        }

        .error-input {
            border-color: #c62828;
            box-shadow: 0 0 5px rgba(198, 40, 40, 0.3);
        }

        .error-message {
            color: #c62828;
            font-size: 0.9rem;
            margin-top: 0.2rem;
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .table-div {
                padding: 1rem;
            }

            td, th {
                padding: 0.8rem;
            }

            .btn {
                display: block;
                margin: 0.5rem 0;
                text-align: center;
            }

            .more-container {
                flex-direction: column;
                gap: 0.5rem;
            }

            form {
                grid-template-columns: 1fr;
            }

            input {
                font-size: 0.9rem;
                min-height: 40px;
            }

            select {
                font-size: 0.8rem;
                min-height: 40px;
            }

            .searchBarContainer {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .searchBarContainer input,
            .searchBarContainer select {
                max-width: 100%;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
                min-height: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Tournament Management</h2>

        <div id="messagesContainer"></div>

        <div class="form-container" id="tournamentFormSection">
            <h3 id="formTitle">Add New Tournament</h3>
            <form class="form-container" id="tournamentForm">
                <input type="hidden" id="tournamentId">

                <div>
                    <label for="tournamentName">Tournament Name:</label>
                    <input type="text" id="tournamentName" required>
                    <div class="error-message" id="tournamentNameError"></div>
                </div>

                <div>
                    <label for="tournamentDate">Date:</label>
                    <input type="date" id="tournamentDate" required>
                    <div class="error-message" id="tournamentDateError"></div>
                </div>

                <div>
                    <label for="tournamentTime">Time:</label>
                    <input type="time" id="tournamentTime" required>
                    <div class="error-message" id="tournamentTimeError"></div>
                </div>

                <div>
                    <label for="tournamentLocation">Location:</label>
                    <input type="text" id="tournamentLocation" required>
                    <div class="error-message" id="tournamentLocationError"></div>
                </div>

                <div>
                    <label for="entryFee">Entry Fee (₹):</label>
                    <input type="number" id="entryFee" min="0" step="0.01" required>
                    <div class="error-message" id="entryFeeError"></div>
                </div>

                <div>
                    <label for="type">Type:</label>
                    <select id="type" required>
                        <option value="" disabled selected>Select Type</option>
                        <option value="Individual">Individual</option>
                        <option value="Team">Team</option>
                    </select>
                    <div class="error-message" id="typeError"></div>
                </div>

                <div>
                    <label for="noOfRounds">No of Rounds:</label>
                    <input type="number" id="noOfRounds" required>
                    <div class="error-message" id="noOfRoundsError"></div>
                </div>

                <div class="add-tournament-button">
                    <button type="submit" id="submitButton">Add Tournament</button>
                </div>
            </form>
        </div>

        <div class="table-div">
            <h3>Your Tournaments</h3>
            <h4>Tournaments you've submitted will appear here with their approval status</h4>
            <div class="searchBarContainer"></div>

            <table>
                <thead>
                    <tr>
                        <th><i class="fas fa-trophy"></i> Name</th>
                        <th><i class="fas fa-calendar"></i> Date</th>
                        <th>Time</th>
                        <th><i class="fas fa-map-marker-alt"></i> Location</th>
                        <th><i class="fas fa-rupee-sign"></i> Entry Fee</th>
                        <th>Type</th>
                        <th>No Of Rounds</th>
                        <th><i class="fas fa-info-circle"></i> Status</th>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                        <th><i class="fas fa-cogs"></i> Remove</th>
                    </tr>
                </thead>
                <tbody id="tournamentsTable">
                    <!-- Tournament rows will be populated by JS -->
                </tbody>
            </table>

            <div class="more-container" id="tournamentsPagination" style="display: none;">
                <a href="#" class="more" id="tournamentsMoreLink">
                    <i class="fas fa-trophy"></i> More
                </a>
                <a href="#" class="hide" id="tournamentsHideLink" style="display: none;">
                    <i class="fas fa-chevron-up"></i> Hide
                </a>
            </div>

            <div class="back-container">
                <a href="/coordinator/coordinator_dashboard" class="back">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
    // ===============================
    // 🧠 Client-side Tournament Management JS
    // ===============================

    const tournamentsTable = document.getElementById('tournamentsTable');
    const messagesContainer = document.getElementById('messagesContainer');
    let tournaments = []; // store fetched tournaments
    let visibleRows = 5;
    const rowsPerPage = 5;

    async function fetchTournaments() {
        try {
            // 🔹 API: GET /coordinator/api/tournaments
            const res = await fetch('/coordinator/api/tournaments');
            if (!res.ok) throw new Error(`Failed: ${res.status}`);
            const data = await res.json();
            tournaments = data.tournaments || [];  // ← Extract array from { tournaments: [...] }
            console.log('Client received tournaments:', tournaments.length);  // Debug: Check count
            renderTournaments();
        } catch (err) {
            console.error(err);
            showMessage('Error fetching tournaments', 'error');
        }
    }

    function showMessage(msg, type='success') {
        messagesContainer.innerHTML = `
            <div class="message ${type}">
                <i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i> ${msg}
            </div>
        `;
        setTimeout(() => { messagesContainer.innerHTML = ''; }, 4000);
    }

   function renderTournaments() {
    tournamentsTable.innerHTML = '';

    // Filter out tournaments with "Removed" status
    const activeTournaments = tournaments.filter(tournament => tournament.status !== 'Removed');

    if (!activeTournaments.length) {
        tournamentsTable.innerHTML = `
            <tr>
                <td colspan="10" class="empty-message">
                    <i class="fas fa-info-circle"></i> No tournaments available.
                </td>
            </tr>
        `;
        document.getElementById('tournamentsPagination').style.display = 'none';
        return;
    }

    activeTournaments.forEach((tournament, index) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize to start of day
        const tDate = new Date(tournament.date);
        tDate.setHours(0, 0, 0, 0); // Normalize to start of day
        let status = tournament.status || 'Pending';
        let statusClass = 'status-pending';

        if (status === 'Approved') {
            if (tDate < today) {
                console.log(`${tDate.toDateString()} < ${today.toDateString()}`);
                status = 'Completed';
                statusClass = 'status-completed';
            } else if (tDate.toDateString() === today.toDateString()) {
                status = 'Ongoing';
                statusClass = 'status-ongoing';
            } else {
                status = 'Yet to Start';
                statusClass = 'status-yet-to-start';
            }
        }

        const tr = document.createElement('tr');
        tr.className = 'tournament-row';
        tr.style.display = index < visibleRows ? '' : 'none';
        tr.innerHTML = `
            <td>${tournament.name}</td>
            <td>${tDate.toLocaleDateString()}</td>
            <td>${tournament.time}</td>
            <td>${tournament.location}</td>
            <td>₹${tournament.entry_fee}</td>
            <td>${tournament.type}</td>
            <td>${tournament.noOfRounds}</td>
            <td class="${statusClass}"><i class="fas fa-circle"></i> ${status}</td>
            <td>
                ${tournament.status === 'Approved' ? `<a href="/coordinator/enrolled_players?tournament_id=${tournament._id}" class="btn"><i class="fas fa-users"></i> Players</a>
                ${tournament.type === 'Individual' ? `<a href="/coordinator/pairings?tournament_id=${tournament._id}&rounds=${tournament.noOfRounds}" class="btn"><i class="fas fa-chess-board"></i> Pairings</a>
                <a href="/coordinator/rankings?tournament_id=${tournament._id}" class="btn"><i class="fas fa-medal"></i> Rankings</a>` : ''}` : ''}
            </td>
            <td>
                <button class="btn btn-remove" onclick="removeTournament('${tournament._id}')"><i class="fas fa-trash"></i> Remove</button>
                ${status === 'Completed' ? 
                  (tournament.feedback_requested ? 
                    `<a href="/coordinator/feedback_view?tournament_id=${tournament._id}" target="_blank" class="btn"><i class="fas fa-eye"></i> View Feedback</a>` : 
                    `<button class="btn" onclick="requestFeedback('${tournament._id}')"><i class="fas fa-comment-dots"></i> Ask Feedback</button>`) : ''}
            </td>
        `;
        tournamentsTable.appendChild(tr);
    });

    // Show/hide pagination
    const pagination = document.getElementById('tournamentsPagination');
    pagination.style.display = activeTournaments.length > 5 ? 'flex' : 'none';
}
     async function requestFeedback(id) {
            try {
                const res = await fetch(`/coordinator/api/tournaments/${id}/request-feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // No body needed since ID is in URL
                });
                const data = await res.json();
                if (data.success) {
                    showMessage('Feedback requested successfully', 'success');
                    await fetchTournaments(); // Refresh table
                } else {
                    showMessage(data.error || 'Failed to request feedback', 'error');
                }
            } catch (err) {
                console.error('Request feedback error:', err);
                showMessage('Error requesting feedback', 'error');
            }
        }

    function removeTournament(id) {
        // 🔹 API: DELETE /coordinator/api/tournaments/:id
        fetch(`/coordinator/api/tournaments/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                showMessage('Tournament removed', 'success');
                tournaments = tournaments.filter(t => t._id !== id);
                renderTournaments();
            })
            .catch(err => {
                console.error(err);
                showMessage('Error removing tournament', 'error');
            });
    }

    // Form validation and submission
    const tournamentForm = document.getElementById('tournamentForm');
    const submitButton = document.getElementById('submitButton');
    const formTitle = document.getElementById('formTitle');
    const tournamentIdInput = document.getElementById('tournamentId');

    let editingId = null;

    function validateForm(formData) {
        let isValid = true;
        const errors = {};

        // Reset error styles
        ['tournamentName', 'tournamentDate', 'tournamentTime', 'tournamentLocation', 'entryFee', 'type', 'noOfRounds'].forEach(field => {
            const input = document.getElementById(field);
            const errorElement = document.getElementById(`${field}Error`);
            input.classList.remove('error-input');
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        });

        // Tournament Name
        const name = formData.tournamentName.trim();
        if (!name) {
            errors.tournamentName = 'Tournament name is required.';
            isValid = false;
        } else if (name.length < 3) {
            errors.tournamentName = 'Tournament name must be at least 3 characters long.';
            isValid = false;
        } else if (!/^[a-zA-Z0-9\s\-&]+$/.test(name)) {
            errors.tournamentName = 'Tournament name can only contain letters, numbers, spaces, hyphens, and &.';
            isValid = false;
        }

        // Date
        const date = formData.tournamentDate;
        if (!date) {
            errors.tournamentDate = 'Date is required.';
            isValid = false;
        } else {
            const inputDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for comparison
            if (isNaN(inputDate.getTime())) {
                errors.tournamentDate = 'Invalid date format.';
                isValid = false;
            } 
            /*else if (inputDate < today) {
                errors.tournamentDate = 'Date cannot be in the past.';
                isValid = false;
            }*/
        }

        // Time
        const time = formData.time.trim();
        if (!time) {
            errors.tournamentTime = 'Time is required.';
            isValid = false;
        } else if (!/^\d{2}:\d{2}$/.test(time)) {
            errors.tournamentTime = 'Invalid time format (use HH:MM).';
            isValid = false;
        }

        // Location
        const location = formData.location.trim();
        if (!location) {
            errors.tournamentLocation = 'Location is required.';
            isValid = false;
        } else if (location.length < 3) {
            errors.tournamentLocation = 'Location must be at least 3 characters long.';
            isValid = false;
        }

        // Entry Fee
        const entryFee = parseFloat(formData.entryFee);
        if (isNaN(entryFee)) {
            errors.entryFee = 'Entry fee is required.';
            isValid = false;
        } else if (entryFee < 0) {
            errors.entryFee = 'Entry fee cannot be negative.';
            isValid = false;
        }

        // Type
        if (!formData.type || formData.type === '') {
            errors.type = 'Please select a tournament type.';
            isValid = false;
        }

        // Number of Rounds
        const noOfRounds = parseInt(formData.noOfRounds);
        if (isNaN(noOfRounds)) {
            errors.noOfRounds = 'Number of rounds is required.';
            isValid = false;
        } else if (noOfRounds <= 0) {
            errors.noOfRounds = 'Number of rounds must be a positive integer.';
            isValid = false;
        } else if (noOfRounds > 100) {
            errors.noOfRounds = 'Number of rounds cannot exceed 100.';
            isValid = false;
        }

        // Display errors
        Object.keys(errors).forEach(field => {
            const errorElement = document.getElementById(`${field}Error`);
            const input = document.getElementById(field);
            errorElement.textContent = errors[field];
            errorElement.style.display = 'block';
            input.classList.add('error-input');
        });

        return isValid;
    }

    tournamentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            tournamentName: document.getElementById('tournamentName').value,
            tournamentDate: document.getElementById('tournamentDate').value,
            time: document.getElementById('tournamentTime').value,
            location: document.getElementById('tournamentLocation').value,
            entryFee: document.getElementById('entryFee').value,
            type: document.getElementById('type').value,
            noOfRounds: document.getElementById('noOfRounds').value
        };

        if (!validateForm(formData)) {
            showMessage('Please correct the errors in the form.', 'error');
            return;
        }

        console.log('Submitting tournament:', formData);

        try {
            const endpoint = editingId ? `/coordinator/api/tournaments/${editingId}` : '/coordinator/api/tournaments';
            const method = editingId ? 'PUT' : 'POST';

            const res = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Failed to add tournament');
            }

            const data = await res.json();
            showMessage(data.message || 'Tournament added successfully!', 'success');

            // Reset form and refresh table
            tournamentForm.reset();
            editingId = null;
            formTitle.textContent = 'Add New Tournament';
            submitButton.textContent = 'Add Tournament';
            tournamentIdInput.value = '';
            await fetchTournaments();
        } catch (err) {
            console.error('Submit error:', err);
            showMessage(`Failed to add tournament: ${err.message}`, 'error');
        }
    });

    function editTournament(id) {
        const tournament = tournaments.find(t => t._id === id);
        if (!tournament) return;

        editingId = id;
        formTitle.textContent = 'Edit Tournament';
        submitButton.textContent = 'Update Tournament';
        tournamentIdInput.value = id;

        document.getElementById('tournamentName').value = tournament.name;
        document.getElementById('tournamentDate').value = new Date(tournament.date).toISOString().split('T')[0];
        document.getElementById('tournamentTime').value = tournament.time;
        document.getElementById('tournamentLocation').value = tournament.location;
        document.getElementById('entryFee').value = tournament.entry_fee;
        document.getElementById('type').value = tournament.type;
        document.getElementById('noOfRounds').value = tournament.noOfRounds;
    }

    // Pagination
    document.getElementById('tournamentsMoreLink').addEventListener('click', e => {
        e.preventDefault();
        visibleRows = Math.min(visibleRows + rowsPerPage, tournaments.length);
        renderTournaments();
    });
    document.getElementById('tournamentsHideLink').addEventListener('click', e => {
        e.preventDefault();
        visibleRows = 5;
        renderTournaments();
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', fetchTournaments);
    </script>
</body>
</html>